<!doctype html>
<html>
<head>
    <title>ΔQ live</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="vendor/pdfkit.js"></script>
    <script src="vendor/blobstream.js"></script>
    <script src="vendor/svgtopdf.js"></script>
    <script src="createpdf.js"></script>
    <style>
      textarea { font-family: monospace; font-size:14px; }
      div.section { display:flex; }
      div.help {margin-left:10px;}
      div.section div { margin-bottom:0.5ex; }
      div.section.closed label:before { content: "▸ "; }
      div.section.closed div.help { display:none; }
      div.section.closed textarea { display:none; }
      div.section.open label:before { content: "▾ "; }
    </style>
    <script>
      function toggleOpen(id) {
        var element = document.getElementById(id);
        element.classList.toggle("open");
        element.classList.toggle("closed");
      }
    </script>
</head>

<body>
    <h1>Try ΔQ live online</h1>
    <div id="div-expr" class="section open">
      <div>
        <label for="expr" onclick="toggleOpen('div-expr')">Outcome expression</label><br/>
        <textarea id="expr" rows="9" cols="50">
(x || never) >> (y && z) [end]</textarea>
      </div>
      <div class="help"><br>
        Possible combinations of outcome expressions (<code><em>expr</em></code>):
        <table>
          <tr>
            <td>Parallel, last-to-finish
            <td><code><em>expr</em> && <em>expr</em></code>
          <tr>
            <td>Parallel, first-to-finish:
            <td><code><em>expr</em> || <em>expr</em></code>
          <tr>
            <td>Sequential composition:
            <td><code><em>expr</em> >> <em>expr</em></code>
          <tr>
            <td>Always fail:
            <td><code>never</code>
          <tr>
            <td>Probabilistic choice:
            <td><code>choice <em>p</em> <em>expr</em> <em>expr</em></code>
          <tr>
            <td>
            <td>where <code><em>p</em></code> is a probability,
            <code>0 <= <em>p</em></code> and <code><em>p</em> <= 1</code>
          <tr>
            <td>&nbsp; or multiple branches:
            <td><code>choices [(<em>w<sub>1</sub></em>,<em>expr<sub>1</sub></em>), <em>…</em>, (<em>w<sub>n</sub></em>,<em>expr<sub>n</sub></em>)]</code>
          <tr>
            <td>
            <td>where <code><em>w<sub>i</sub></em></code> are weights
          <tr>
            <td>Observation locations:
            <td><code>[<em>label</em>] <em>expr</em></code>
          <tr>
            <td>
            <td><code><em>expr</em> [<em>label</em>]</code>
        </table>
      </div>
    </div>
    <div id="div-vars" class="section open">
      <div>
        <label for="vars" onclick="toggleOpen('div-vars')">Variable assignments</label><br/>
        <textarea id="vars" rows="5" cols="50">
x = uniform 0 1
y = wait 2
z = uniform 0 3</textarea>
      </div>
      <div class="help" style="margin-top:20px;">
        Possible variable assignments:
        <table>          
          <tr>
            <td>Deterministic time delay:
            <td><code><em>var</em> = wait <em>t<sub>1</sub></em></code>
          <tr>
            <td>Uniform distribution on interval:
            <td><code><em>var</em> = uniform <em>t<sub>1</sub></em> <em>t<sub>2</sub></em></code>
        </table>
      </div>
    </div>
    <div id="div-loc" class="section closed">
      <div>
        <label for="loc" onclick="toggleOpen('div-loc')">Observation locations</label><br/>
        <textarea id="loc" rows="8" cols="50"></textarea>
      </div>
      <div class="help"><br>
        Syntax for additional observation locations:
        <table>
          <tr>
            <td>Location before an outcome
            <td><code>|<-- <em>expr</em> = "<em>label</em>"</code>
          <tr>
            <td>Location after an outcome
            <td><code><em>expr</em> &minus;->| = "<em>label</em>"</code>
        </table>
      </div>

    </div>
    <div>
      <input type="button" id="eval" value="Render"/>
      <input type="button" id="create-pdf" value="Download diagram (PDF)"
        onclick="createAndDownloadPDF(document.getElementById('out-diagram').children[0].children[1])" disabled/>
      <a style="display:none" id="pdf-file" download='outcome-diagram.pdf'></a>
      <input type="button" id="link" value="Copy link"
        onclick="copyLink()"/>
    </div>
    <pre id="out-error"></pre>
    Outcome diagram:
    <div id="out-diagram">
      —
    </div>
    ΔQ:
    <div id="out-times">
      —
    </div>
    <script type="module" src="runtime.js"></script>
    <script>
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);

      const textAreaFromURIParam = (id) => {
        const s = urlParams.get(id);
        if (s) { document.getElementById(id).value = decodeURIComponent(s); }
      };

      textAreaFromURIParam('expr');
      textAreaFromURIParam('vars');
      textAreaFromURIParam('loc');

      const uriParamFromTextArea = (id) => {
        return id + '=' + encodeURIComponent(document.getElementById(id).value);
      }

      const copyLink = () => {
        const base = window.location.origin + window.location.pathname;
        let query = ""
        query = query + '?' + uriParamFromTextArea('expr');
        query = query + '&' + uriParamFromTextArea('vars');
        query = query + '&' + uriParamFromTextArea('loc');
        navigator.clipboard.writeText(base + encodeURI(query));
      };
    </script>
</body>
</html>
